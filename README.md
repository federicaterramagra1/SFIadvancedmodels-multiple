# Fault Injection Tool for the Reliability Assessment of Deep Learning Algorithms

## Overview
**SFIadvancedmodels** is an open-source software designed to test the resilience of deep learning algorithms against random hardware faults. The intent of the framework is to perform advanced statistical fault injection analyses by extending existing fault models available in the literature.

## Project Structure
This project is structured as follows:

- `requirements.txt`: Packages to install in a virtual environment to run the application.
- `main.py`: The main entry point for the application. It handles fault list generation, fault injection campaigns (saving clean/faulty outputs and feature maps), and final fault analysis.
- `SETTINGS.py`: Configuration file to set experiment preferences.
- `utils.py`: Utility functions and helper modules.
- `faultManager/`: Code to manage fault injection campaigns.
- `ofmapManager/`: Tools to save the output feature maps (OFMs) of the clean network.
- `dlModels/`: Contains model definitions and pretrained weights.

## Setup

### Clone the repository
```bash
git clone https://github.com/your-username/SFIadvancedmodels.git
```

### Creating a Python Environment
We recommend creating a virtual environment:
```bash
python3 -m venv environment_name
source environment_name/bin/activate
```

### Installing Dependencies
```bash
pip install -r requirements.txt
```

## Usage
To generate the fault list, execute fault injection, or analyze data, configure your experiment in `SETTINGS.py`, then run:
```bash
python3 main.py
```
To analyze and visualize the summarized results (e.g., failure rate distribution, most critical layers/faults), run:
```bash
python3 genGraph.py
```


## Configuration Parameters

### `NUM_FAULTS_TO_INJECT`
Specifies how many **individual faults (bit flips)** are combined **within a single fault injection group**.

- For example, if `NUM_FAULTS_TO_INJECT = 2`, the system will generate fault groups where **2 bit flips are injected simultaneously**, potentially in different positions of the same or different weights.
- These combinations are precomputed and stored in the fault list during the `FAULT_LIST_GENERATION` phase.

### `FAULTS_TO_INJECT`
Defines the **number of fault groups to be injected** during the campaign.

- If `FAULTS_TO_INJECT = -1`, the system performs a **full exhaustive campaign**, injecting **all possible combinations** of faults generated according to `NUM_FAULTS_TO_INJECT`.
- If `FAULTS_TO_INJECT` is set to a positive integer (e.g., 1000), a **random subset of 1000 fault groups** will be sampled from the fault list.

### Example
If:
```python
NUM_FAULTS_TO_INJECT = 3
FAULTS_TO_INJECT = 1000
```
## Outputs
The application is modular, and behavior is controlled by boolean flags in `SETTINGS.py`:

- `FAULT_LIST_GENERATION`: Generates the fault list.
- `FAULTS_INJECTION`: Loads the fault list and performs the fault injection campaign, saving clean/faulty outputs and optionally OFMs.
- `FI_ANALYSIS`: Compares clean and corrupted outputs, classifies each fault, and logs metrics.
- `FI_ANALYSIS_SUMMARY`: Generates a summarized CSV file from the fault analysis to improve readability when injecting many faults.

### Output Directories
- `output/clean_feature_maps/`: Clean feature maps (OFMs).
- `output/clean_output/`: Clean inference outputs.
- `output/fault_list/`: The fault lists.
- `output/faulty_feature_maps/`: Faulty OFMs.
- `output/faulty_output/`: Faulty inference outputs.
- `results/`: Full CSV logs of output analyses.
- `results_summary/`: Summarized fault impact analysis.

### Output File Naming Conventions
- Clean FM: `batch_[batch_id]_layer_[layer_name].npz`
- Clean output: `clean_output.npy`
- Faulty FM: `fault_[fault_id]_batch_[batch_id]_layer_[layer_name].npz`
- Faulty output: `[fault_model]/batch_[batch_id].npy`

### Tensor Shapes
- Clean OFMs: `B x K x H x W`
- Clean output: `N x B x C`
- Faulty OFMs: `B x K x H x W`
- Faulty output: `F x B x C`

Where:
- `F`: Number of faults
- `N`: Number of batches
- `B`: Batch size
- `C`: Number of classes
- `K`: Channels
- `H`, `W`: Height and width

### Loading Arrays
- OFMs: `np.load(file_name)['arr_0']`
- Outputs: `np.load(file_name, allow_pickle=True)`

## Fault List Format
The fault list is a CSV file structured as:

| Injection | Layer       | TensorIndex      | Bit |
|-----------|-------------|------------------|-----|
| 0         | fc1         | (2, 1)           | 3   |

- `Injection`: Unique fault ID.
- `Layer`: Layer name.
- `TensorIndex`: Position in the weight tensor.
- `Bit`: Bit index flipped or stuck.

## Output Analysis
Files generated by `FI_ANALYSIS` are located in:
```
results/<dataset>/<model>/<batch_size>/
```
Includes:
- `output_analysis.csv`: CSV listing fault behavior on each image in each batch.
- `fault_statistics.txt`: Summary of total masked, non-critical, and critical (SDC-1) faults.

`output_analysis.csv` example:

| Fault_ID | Batch | Image | Output |
|----------|-------|-------|--------|
| 0        | 0     | 0     | 1      |

Where:
- `0`: masked
- `1`: non-critical
- `2`, `3`: increasingly critical but same class
- `4`: SDC-1 (silent data corruption)

## Summary File Format
Generated with `FI_ANALYSIS_SUMMARY`, saved in:
```
results_summary/<dataset>/<model>/<batch_size>/model_summary.csv
```

| Injection | Layers  | TensorIndices | Bits | masked | non_critical | critical | accuracy | failure_rate |
|-----------|---------|----------------|------|--------|---------------|----------|----------|---------------|

- Summarizes fault impact across all test samples.
- Useful for ranking the most critical faults.

## Acknowledgments
This work is supported by FAIR - Future Artificial Intelligence Research and funded by the EU Next-GenerationEU initiative (PNRR - Mission 4, Component 2, Investment 1.3, D.D. 1555 11/10/2022, PE00000013). The content reflects only the authors' views; the European Union is not responsible for any use that may be made of the information it contains.